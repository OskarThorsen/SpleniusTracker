<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpleniusTracker v54 (Mobile-Friendly UI)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lexend:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'sans-serif'],
                        heading: ['Lexend', 'sans-serif'],
                    },
                    colors: {
                        'jet-black': '#0A0A0A',
                        'panel-dark': '#151518',
                        'panel-light': '#FFFFFF',
                        'accent-yellow': '#FFD100',
                        'accent-yellow-hover': '#FFC300',
                        'info-blue': '#3E85FF',
                        'success-green': '#32D74B',
                        'alert-red': '#FF3B30',
                        'text-primary-dark': '#F0F0F0',
                        'text-secondary-dark': '#A1A1A6',
                        'text-primary-light': '#0B0C0F',
                        'text-secondary-light': '#6A6A6E',
                        'border-dark': '#2A2A2E',
                    },
                    fontSize: {
                        'display-l': ['48px', '52px'],
                        'title-m': ['20px', '24px'],
                        'body-s': ['14px', '20px'],
                    },
                    opacity: {
                        '95': '.95',
                    },
                    boxShadow: {
                        'glow-yellow': '0 0 15px 0 rgba(255, 209, 0, 0.25)',
                        'glow-blue': '0 0 15px 0 rgba(62, 133, 255, 0.25)',
                        'glow-red': '0 0 15px 0 rgba(255, 59, 48, 0.25)',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: 0 }, '100%': { opacity: 1 } },
                        fadeInSlideUp: { '0%': { opacity: 0, transform: 'translateY(15px)' }, '100%': { opacity: 1, transform: 'translateY(0)' } },
                        modalShow: { '0%': { opacity: 0, transform: 'translateY(20px) scale(0.95)' }, '100%': { opacity: 1, transform: 'translateY(0) scale(1)' } },
                    },
                    animation: {
                        fadeIn: 'fadeIn 0.5s ease-out',
                        fadeInSlideUp: 'fadeInSlideUp 0.6s ease-out forwards',
                        modalShow: 'modalShow 0.4s cubic-bezier(0.25, 1, 0.5, 1) forwards',
                    }
                }
            }
        }
    </script>
    <style>
        .view { display: none; }
        .view.active { display: block; }
        .font-heading { font-family: 'Lexend', sans-serif; }
        .main-content::-webkit-scrollbar { width: 8px; }
        .main-content::-webkit-scrollbar-track { background: transparent; }
        .main-content::-webkit-scrollbar-thumb { background-color: #2A2A2E; border-radius: 4px; }
        body { background-image: radial-gradient(#151518 1px, transparent 1px); background-size: 20px 20px; }
        .bg-panel-dark { backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); background-color: rgba(21, 21, 24, 0.7); border: 1px solid #2A2A2E; }
        Chart.defaults.color = '#A1A1A6';
        Chart.defaults.borderColor = '#2A2A2E';
        Chart.defaults.font.family = "Inter, sans-serif";
    </style>
</head>
<body class="bg-jet-black text-text-primary-dark font-sans">
    
    <!-- Login View -->
    <div id="login-view" class="view active w-full h-screen grid grid-cols-1 md:grid-cols-2">
        <div class="hidden md:flex flex-col justify-center items-center bg-panel-dark p-12 text-center">
             <svg class="w-24 h-24 mb-6 text-accent-yellow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M12 12c-3 0-5.5 2.5-5.5 5.5"/><path d="M12 12c3 0 5.5-2.5 5.5-5.5"/></svg>
            <h1 class="font-heading text-5xl font-bold mb-3 text-text-primary-dark">SpleniusTracker</h1>
            <p class="text-lg text-text-secondary-dark max-w-sm">
                Få kontroll over nakkesmerter og migrene. Loggfør, analyser og se fremgangen din.
            </p>
        </div>
        <div class="w-full h-full flex flex-col justify-center items-center bg-jet-black p-6 sm:p-8 overflow-y-auto">
            <div class="w-full max-w-sm">
                <div class="text-center mb-8 md:hidden">
                    <svg class="w-16 h-16 mx-auto text-accent-yellow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M12 12c-3 0-5.5 2.5-5.5 5.5"/><path d="M12 12c3 0 5.5-2.5 5.5-5.5"/></svg>
                    <h1 class="font-heading text-3xl font-bold text-text-primary-dark mt-2">SpleniusTracker</h1>
                </div>
                <div class="bg-panel-dark p-8 rounded-2xl w-full">
                    <h2 class="font-heading text-2xl font-bold text-text-primary-dark mb-1">Velkommen!</h2>
                    <p class="text-text-secondary-dark mb-6 text-body-s">Logg inn eller registrer deg for å fortsette.</p>
                    <div id="auth-error" class="bg-alert-red/20 text-alert-red text-body-s p-3 rounded-lg mb-4 hidden"></div>
                    <form id="login-form" class="space-y-4">
                        <input type="text" id="name" placeholder="Navn (kun for registrering)" class="w-full p-3 bg-jet-black border border-border-dark rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-yellow transition placeholder:text-text-secondary-dark/50">
                        <input type="email" id="email" required placeholder="E-post" class="w-full p-3 bg-jet-black border border-border-dark rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-yellow transition">
                        <input type="password" id="password" required placeholder="Passord" class="w-full p-3 bg-jet-black border border-border-dark rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-yellow transition">
                        <div class="pt-4 space-y-3">
                             <button type="button" id="login-btn" class="w-full bg-accent-yellow text-jet-black font-semibold py-3 px-4 rounded-lg hover:bg-accent-yellow-hover focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-jet-black focus:ring-accent-yellow transition-all shadow-lg shadow-accent-yellow/10 hover:shadow-accent-yellow/20">Logg Inn</button>
                             <button type="button" id="signup-btn" class="w-full bg-border-dark text-text-primary-dark font-semibold py-3 px-4 rounded-lg hover:bg-border-dark/70 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-jet-black focus:ring-accent-yellow transition-all">Registrer ny bruker</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App View -->
    <div id="app-view" class="view w-full min-h-screen bg-jet-black flex">
        <!-- Responsive Sidebar -->
        <aside class="bg-panel-dark p-2 md:p-4 flex flex-col flex-shrink-0 w-20 md:w-64 transition-all duration-300">
            <!-- Logo -->
            <div class="flex items-center justify-center md:justify-start gap-3 p-2 md:p-4 mb-4 h-16">
                <svg class="w-8 h-8 text-accent-yellow flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M12 12c-3 0-5.5 2.5-5.5 5.5"/><path d="M12 12c3 0 5.5-2.5 5.5-5.5"/></svg>
                <span class="font-heading font-bold text-xl hidden md:inline">SpleniusTracker</span>
            </div>
            
            <!-- Navigation Links -->
            <nav class="flex-grow">
                <ul class="space-y-2">
                    <li><a href="#" class="flex items-center justify-center md:justify-start gap-3 px-2 py-3 md:px-4 md:py-2 rounded-lg bg-jet-black text-accent-yellow" title="Dashboard"><i class="fa-solid fa-chart-line w-8 md:w-5 text-center text-lg"></i><span class="hidden md:inline">Dashboard</span></a></li>
                    <li><a href="#" class="flex items-center justify-center md:justify-start gap-3 px-2 py-3 md:px-4 md:py-2 rounded-lg hover:bg-jet-black" title="Ny Logg"><i class="fa-solid fa-plus w-8 md:w-5 text-center text-lg"></i><span class="hidden md:inline">Ny Logg</span></a></li>
                    <li><a href="#" class="flex items-center justify-center md:justify-start gap-3 px-2 py-3 md:px-4 md:py-2 rounded-lg hover:bg-jet-black" title="Historikk"><i class="fa-solid fa-book w-8 md:w-5 text-center text-lg"></i><span class="hidden md:inline">Historikk</span></a></li>
                    <li><a href="#" class="flex items-center justify-center md:justify-start gap-3 px-2 py-3 md:px-4 md:py-2 rounded-lg hover:bg-jet-black" title="Innstillinger"><i class="fa-solid fa-gear w-8 md:w-5 text-center text-lg"></i><span class="hidden md:inline">Innstillinger</span></a></li>
                </ul>
            </nav>

            <!-- User Info and Logout -->
            <div class="border-t border-border-dark pt-4">
                <div class="flex items-center justify-center md:justify-start gap-3 p-2 md:px-4 md:py-2">
                    <div id="user-initial" class="w-10 h-10 rounded-full bg-accent-yellow flex items-center justify-center font-bold text-jet-black flex-shrink-0"></div>
                    <div class="hidden md:inline">
                        <p class="font-semibold text-text-primary-dark truncate" id="user-name-display">Laster...</p>
                        <p class="text-xs text-text-secondary-dark truncate" id="user-email-display">Laster...</p>
                    </div>
                </div>
                 <button id="logout-btn" class="w-full mt-2 flex items-center justify-center md:justify-start gap-3 px-2 py-3 md:px-4 md:py-2 rounded-lg text-text-secondary-dark hover:bg-jet-black hover:text-alert-red" title="Logg ut">
                    <i class="fa-solid fa-arrow-right-from-bracket w-8 md:w-5 text-center text-lg"></i>
                    <span class="hidden md:inline">Logg ut</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-4 sm:p-6 lg:p-8 overflow-y-auto main-content">
            <h1 class="font-heading text-3xl md:text-4xl font-bold mb-6 animate-fadeInSlideUp">Dashboard</h1>
            
            <!-- Responsive Stats Grid -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-6 md:mb-8 animate-fadeInSlideUp" style="animation-delay: 100ms;">
                <div class="bg-panel-dark p-5 rounded-2xl">
                    <h3 class="text-text-secondary-dark text-sm font-medium mb-2">Smerte i dag</h3>
                    <p class="text-3xl font-bold text-alert-red">7 <span class="text-lg text-text-secondary-dark">/ 10</span></p>
                </div>
                <div class="bg-panel-dark p-5 rounded-2xl">
                    <h3 class="text-text-secondary-dark text-sm font-medium mb-2">Søvnkvalitet</h3>
                    <p class="text-3xl font-bold text-info-blue">6t 30m</p>
                </div>
                <div class="bg-panel-dark p-5 rounded-2xl">
                    <h3 class="text-text-secondary-dark text-sm font-medium mb-2">Medisin tatt</h3>
                    <p class="text-3xl font-bold text-success-green">Ja</p>
                </div>
                <div class="bg-panel-dark p-5 rounded-2xl">
                    <h3 class="text-text-secondary-dark text-sm font-medium mb-2">Loggførte dager</h3>
                    <p class="text-3xl font-bold">14</p>
                </div>
            </div>

            <!-- Chart Container -->
            <div class="bg-panel-dark p-4 md:p-6 rounded-2xl animate-fadeInSlideUp" style="animation-delay: 200ms;">
                <h3 class="font-heading text-xl font-bold mb-4">Smertehistorikk (Siste 7 dager)</h3>
                <div class="h-80">
                    <canvas id="painChart"></canvas>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase and App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            signInWithCustomToken,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config)
            : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- Initialize Firebase ---
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            document.getElementById('auth-error').textContent = "Kritisk feil: Kunne ikke koble til Firebase.";
            document.getElementById('auth-error').classList.remove('hidden');
        }

        // --- DOM Element References ---
        const loginView = document.getElementById('login-view');
        const appView = document.getElementById('app-view');
        const authErrorDiv = document.getElementById('auth-error');
        const nameInput = document.getElementById('name');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userNameDisplay = document.getElementById('user-name-display');
        const userEmailDisplay = document.getElementById('user-email-display');
        const userInitial = document.getElementById('user-initial');
        
        let painChart = null;

        // --- Main App Logic ---
        if (auth) {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // User is signed in
                    appView.classList.add('active');
                    loginView.classList.remove('active');
                    await setupUserInfo(user);
                    setupDashboard();
                } else {
                    // User is signed out
                    loginView.classList.add('active');
                    appView.classList.remove('active');
                }
            });
        }
        
        async function setupUserInfo(user) {
            const userDocRef = doc(db, 'artifacts', appId, 'users', user.uid);
            const userDocSnap = await getDoc(userDocRef);
            if (userDocSnap.exists()) {
                const userData = userDocSnap.data();
                userNameDisplay.textContent = userData.name;
                userEmailDisplay.textContent = userData.email;
                userInitial.textContent = userData.name.charAt(0).toUpperCase();
            } else {
                userNameDisplay.textContent = user.displayName || "Gjest";
                userEmailDisplay.textContent = user.email || "Anonym bruker";
                userInitial.textContent = user.isAnonymous ? 'G' : (user.displayName || user.email || 'B').charAt(0).toUpperCase();
            }
        }

        function setupDashboard() {
            // Only create chart if it doesn't exist
            if (painChart) {
                painChart.destroy();
            }
            const ctx = document.getElementById('painChart').getContext('2d');
            
            // Sample data
            const labels = Array.from({length: 7}, (_, i) => {
                const d = new Date();
                d.setDate(d.getDate() - i);
                return d;
            }).reverse();

            const data = {
                labels: labels,
                datasets: [{
                    label: 'Smerte nivå',
                    data: [6, 5, 7, 8, 6, 7, 5],
                    fill: true,
                    borderColor: 'rgba(255, 209, 0, 1)',
                    backgroundColor: 'rgba(255, 209, 0, 0.1)',
                    tension: 0.4,
                    pointBackgroundColor: '#FFD100',
                    pointBorderColor: '#151518',
                    pointHoverBackgroundColor: '#FFFFFF',
                    pointHoverBorderColor: '#FFD100',
                    pointRadius: 5,
                    pointHoverRadius: 8,
                }]
            };

            painChart = new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10,
                            grid: { color: '#2A2A2E' },
                        },
                        x: {
                            type: 'time',
                            time: { unit: 'day', displayFormats: { day: 'd MMM' } },
                            grid: { display: false },
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#0A0A0A',
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 12 },
                            padding: 12,
                            cornerRadius: 8,
                            displayColors: false,
                        }
                    }
                }
            });
        }

        // --- Event Listeners ---
        signupBtn.addEventListener('click', async () => {
            const name = nameInput.value.trim();
            const email = emailInput.value.trim();
            const password = passwordInput.value;
            if (!name || !email || password.length < 6) {
                showAuthError("Fyll ut alle felt. Passord må være minst 6 tegn.");
                return;
            }
            try {
                hideAuthError();
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                await setDoc(doc(db, 'artifacts', appId, 'users', user.uid), { name, email, createdAt: new Date() });
            } catch (error) {
                showAuthError(getFriendlyAuthError(error.code));
            }
        });

        loginBtn.addEventListener('click', async () => {
            const email = emailInput.value.trim();
            const password = passwordInput.value;
            if (!email || !password) {
                showAuthError("Fyll ut e-post og passord.");
                return;
            }
            try {
                hideAuthError();
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                showAuthError(getFriendlyAuthError(error.code));
            }
        });
        
        logoutBtn.addEventListener('click', () => signOut(auth));

        // --- Utility Functions ---
        function showAuthError(message) {
            authErrorDiv.innerHTML = message;
            authErrorDiv.classList.remove('hidden');
        }
        function hideAuthError() {
            authErrorDiv.classList.add('hidden');
        }
        function getFriendlyAuthError(errorCode) {
            // ... (error messages as before)
            return `En feil oppstod (${errorCode}). Prøv igjen.`;
        }
        
        // --- Initial Authentication Flow ---
        async function initialAuth() {
            if (!auth || auth.currentUser) return;
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Critical initial auth error:", error);
                showAuthError(getFriendlyAuthError(error.code));
            }
        }

        initialAuth();

    </script>
</body>
</html>
