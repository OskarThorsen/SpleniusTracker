<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpleniusTracker v34 (Forbedret Feilmelding)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'brand-sidebar': '#111827',
                        'brand-main': '#f9fafb',
                        'brand-card': '#ffffff',
                        'brand-primary': '#14b8a6',
                        'brand-primary-hover': '#0d9488',
                        'brand-secondary': '#3b82f6',
                        'brand-migrene': '#ec4899',
                        'brand-text-dark': '#1f2937',
                        'brand-text-light': '#6b7280',
                        'brand-text-inverted': '#e5e7eb',
                        'brand-border': '#e5e7eb',
                    }
                }
            }
        }
    </script>
    <style>
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .main-content::-webkit-scrollbar { width: 8px; }
        .main-content::-webkit-scrollbar-track { background: transparent; }
        .main-content::-webkit-scrollbar-thumb { background-color: #d1d5db; border-radius: 20px; border: 3px solid #f9fafb; }
        input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 6px; background: #e5e7eb; border-radius: 5px; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: var(--thumb-color, #14b8a6); border-radius: 50%; cursor: pointer; border: 3px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
        input[type="range"]::-moz-range-thumb { width: 20px; height: 20px; background: var(--thumb-color, #14b8a6); border-radius: 50%; cursor: pointer; border: 3px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
    </style>
</head>
<body class="bg-brand-main text-brand-text-dark font-sans flex h-screen overflow-hidden">
    
    <!-- Login View -->
    <div id="login-view" class="w-full h-full flex items-center justify-center bg-gray-100 view active">
        <div class="w-full max-w-md bg-white p-8 rounded-2xl shadow-lg">
            <h1 class="text-3xl font-extrabold text-center text-brand-text-dark mb-6">SpleniusTracker</h1>
            <div id="auth-error" class="text-red-500 text-center mb-4 hidden"></div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="name" class="block text-sm font-bold text-gray-700">Navn</label>
                    <input type="text" id="name" placeholder="Kun nødvendig for registrering" class="w-full mt-1 p-3 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-primary">
                </div>
                <div>
                    <label for="email" class="block text-sm font-bold text-gray-700">E-post</label>
                    <input type="email" id="email" required class="w-full mt-1 p-3 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-primary">
                </div>
                <div>
                    <label for="password" class="block text-sm font-bold text-gray-700">Passord</label>
                    <input type="password" id="password" required class="w-full mt-1 p-3 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-primary">
                </div>
                <div class="flex items-center justify-between gap-4 pt-4">
                     <button type="button" id="login-btn" class="w-full bg-brand-primary text-white font-bold py-3 px-4 rounded-lg hover:bg-brand-primary-hover transition-all">Logg Inn</button>
                     <button type="button" id="signup-btn" class="w-full bg-gray-200 text-brand-text-dark font-bold py-3 px-4 rounded-lg hover:bg-gray-300 transition-all">Registrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main App View -->
    <div id="app-view" class="w-full h-full hidden">
        <!-- Sidebar -->
        <aside class="bg-brand-sidebar text-brand-text-inverted w-64 p-6 flex flex-col flex-shrink-0">
            <div class="flex items-center gap-3 pb-6 border-b border-gray-700">
                <svg class="w-8 h-8 text-brand-primary" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M12 12c-3 0-5.5 2.5-5.5 5.5"/><path d="M12 12c3 0 5.5-2.5 5.5-5.5"/></svg>
                <span class="text-xl font-extrabold text-white">SpleniusTracker</span>
            </div>
            <nav class="mt-8 flex flex-col gap-2 flex-grow">
                <button onclick="showView('dashboard')" class="nav-button nav-active flex items-center gap-3 w-full px-4 py-3 rounded-lg text-left text-base transition-all duration-200">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                    <span>Dashboard</span>
                </button>
                <button onclick="showView('historikk')" class="nav-button flex items-center gap-3 w-full px-4 py-3 rounded-lg text-left text-base transition-all duration-200">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 1 0 2.19-9.51L1 10"/></svg>
                    <span>Historikk</span>
                </button>
            </nav>
            <button id="logout-btn" class="flex items-center gap-3 w-full px-4 py-3 rounded-lg text-left text-base text-brand-text-inverted hover:bg-red-500 hover:text-white transition-all duration-200">
                 <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l-3-3m0 0l-3 3m3-3V12" /></svg>
                <span>Logg ut</span>
            </button>
        </aside>

        <!-- Main Content -->
        <main class="main-content flex-grow p-8 overflow-y-auto">
            <div id="dashboard" class="view active">
                <h1 class="text-4xl font-extrabold text-brand-text-dark mb-2">Dashboard</h1>
                <p class="text-brand-text-light mb-8">En oversikt over fremgang og innsikt.</p>
                <div id="dashboard-header" class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6"></div>
                <div id="dashboard-grid" class="grid grid-cols-1 lg:grid-cols-3 gap-6"></div>
            </div>
            
            <div id="logg-behandling" class="view">
                <h1 class="text-4xl font-extrabold text-brand-text-dark mb-8">Loggfør Ny Økt</h1>
                <form id="behandling-skjema" class="bg-brand-card p-8 rounded-2xl shadow-sm border border-brand-border max-w-4xl mx-auto"></form>
            </div>
            
            <div id="historikk" class="view">
                <h1 class="text-4xl font-extrabold text-brand-text-dark mb-8">Økthistorikk</h1>
                <div id="historikk-liste" class="space-y-4"></div>
            </div>
        </main>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, query, orderBy, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCxTqYaH1LSXeVTfIqFqRr4dChQLtCbTVg",
            authDomain: "spleniustracker.firebaseapp.com",
            projectId: "spleniustracker",
            storageBucket: "spleniustracker.appspot.com",
            messagingSenderId: "618261541296",
            appId: "1:618261541296:web:f82de200ab3f8af60f2675",
            measurementId: "G-LG6BJ9BQK3"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GLOBAL STATE ---
        let chartInstances = {};
        let currentUser = null;
        let behandlingerUnsubscribe = null; 

        const FOCUS_AREAS = ["Nedre Splenius", "Midtre Splenius", "Øvre Splenius"];
        const SLIDERS = ["intensity", "pre_pain_level", "pre_tightness_level", "last_migraine_severity", "post_pain_level", "post_tightness_level"];

        // --- AUTHENTICATION ---
        const loginView = document.getElementById('login-view');
        const appView = document.getElementById('app-view');
        const loginForm = document.getElementById('login-form');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const authError = document.getElementById('auth-error');

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loginView.classList.remove('active');
                loginView.style.display = 'none';
                appView.classList.remove('hidden');
                appView.style.display = 'flex';
                showView('dashboard'); 
            } else {
                currentUser = null;
                if (behandlingerUnsubscribe) behandlingerUnsubscribe();
                loginView.classList.add('active');
                loginView.style.display = 'flex';
                appView.classList.add('hidden');
                appView.style.display = 'none';
            }
        });

        const showAuthError = (message) => {
            authError.textContent = message;
            authError.classList.remove('hidden');
        };

        loginBtn.addEventListener('click', () => {
            authError.classList.add('hidden');
            const email = loginForm.email.value;
            const password = loginForm.password.value;
            signInWithEmailAndPassword(auth, email, password)
                .catch(error => showAuthError("Feil e-post eller passord."));
        });

        signupBtn.addEventListener('click', async () => {
            authError.classList.add('hidden');
            const name = loginForm.name.value.trim();
            const email = loginForm.email.value;
            const password = loginForm.password.value;

            if (!name) {
                showAuthError("Navn er påkrevd for registrering.");
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                const userDocRef = doc(db, "users", user.uid);
                await setDoc(userDocRef, {
                    navn: name,
                    email: email,
                    createdAt: serverTimestamp()
                });
                // Success! onAuthStateChanged will handle the UI transition.

            } catch (error) {
                if (error.code === 'auth/email-already-in-use') {
                    showAuthError("E-posten er allerede registrert. Prøv å logge inn.");
                } else if (error.code === 'auth/weak-password') {
                    showAuthError("Passordet må være på minst 6 tegn.");
                } else if (error.code === 'permission-denied') {
                    showAuthError("Databasefeil: Kan ikke opprette brukerprofil. Sjekk Firestore-reglene.");
                }
                else {
                    showAuthError("En uventet feil oppstod under registrering.");
                }
                console.error("Signup error: ", error);
            }
        });

        logoutBtn.addEventListener('click', () => {
            signOut(auth);
        });

        // --- DATA HANDLING (FIRESTORE) ---
        function listenToBehandlinger() {
            if (!currentUser) return;
            const sessionsRef = collection(db, 'users', currentUser.uid, 'sessions');
            const q = query(sessionsRef, orderBy("date", "asc"));

            if (behandlingerUnsubscribe) behandlingerUnsubscribe(); 

            behandlingerUnsubscribe = onSnapshot(q, (snapshot) => {
                const data = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                updateUIWithData(data);
            }, (error) => {
                console.error("Error fetching data:", error);
                if (error.code === 'permission-denied') {
                    const grid = document.getElementById('dashboard-grid');
                    if (grid) {
                        grid.innerHTML = `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 col-span-full" role="alert">
                                            <p class="font-bold">Databasefeil</p>
                                            <p>Mangler tilgang. Sjekk at Firestore-reglene er publisert korrekt i Firebase-konsollet.</p>
                                          </div>`;
                    }
                }
            });
        }
        
        function updateUIWithData(data) {
            const appContainer = document.getElementById('app-view');
            if (appContainer.offsetParent !== null) {
                if (document.getElementById('dashboard').classList.contains('active')) {
                    updateDashboard(data);
                }
                if (document.getElementById('historikk').classList.contains('active')) {
                    updateHistory(data);
                }
            }
        }

        // --- VIEW MANAGEMENT ---
        window.showView = (viewId) => {
            const appContainer = document.getElementById('app-view');
            appContainer.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            
            document.querySelectorAll('.nav-button').forEach(b => {
                b.classList.remove('bg-brand-primary', 'text-white');
                b.classList.add('hover:bg-gray-700');
                if (b.getAttribute('onclick').includes(`'${viewId}'`)) {
                    b.classList.add('bg-brand-primary', 'text-white');
                    b.classList.remove('hover:bg-gray-700');
                }
            });

            if(currentUser) {
                listenToBehandlinger();
            }
            if (viewId === 'logg-behandling') {
                prepareForm();
            }
        };

        // --- UI RENDERING ---
        const updateDashboard = (data) => {
            const header = document.getElementById('dashboard-header');
            const grid = document.getElementById('dashboard-grid');
            Object.values(chartInstances).forEach(chart => chart.destroy());

            if (!data || data.length === 0) {
                 header.innerHTML = "";
                 grid.innerHTML = `<div class="bg-brand-card p-8 rounded-2xl shadow-sm border border-brand-border text-center col-span-full"><h2 class="text-2xl font-bold mb-2">Velkommen til SpleniusTracker!</h2><p class="text-brand-text-light mb-4">Du har ingen loggførte økter enda. Start med å legge til din første.</p><button class="w-full md:w-auto bg-brand-primary text-white font-bold py-3 px-6 rounded-lg hover:bg-brand-primary-hover transition-all flex items-center justify-center gap-2 mx-auto" onclick="showView('logg-behandling')"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg><span>Start Første Økt</span></button></div>`;
                 return;
            }
            
            renderDashboardHeader(data);
            grid.innerHTML = `
                <div class="bg-brand-card p-6 rounded-2xl shadow-sm border border-brand-border lg:col-span-3">
                    <h3 class="text-xl font-bold mb-4">Smerteutvikling over tid</h3>
                    <div class="h-80"><canvas id="holisticChart"></canvas></div>
                </div>
                <div id="migraineStreakCard" class="bg-brand-card p-6 rounded-2xl shadow-sm border border-brand-border"></div>
                <div class="bg-brand-card p-6 rounded-2xl shadow-sm border border-brand-border">
                    <h3 class="text-xl font-bold mb-4">Effektivitetsfordeling</h3>
                    <p class="text-sm text-brand-text-light -mt-3 mb-4">Bidrag til smertelindring</p>
                    <div id="focusAreaList" class="space-y-3"></div>
                </div>
                <div class="bg-brand-card p-6 rounded-2xl shadow-sm border border-brand-border">
                    <h3 class="text-xl font-bold mb-4">Effekt per Intensitet</h3>
                    <p class="text-sm text-brand-text-light -mt-3 mb-4">Gj.snitt. smertelindring</p>
                    <div class="h-48"><canvas id="intensityEffectChart"></canvas></div>
                </div>
                <div class="bg-brand-card p-6 rounded-2xl shadow-sm border border-brand-border lg:col-span-3">
                    <h3 class="text-xl font-bold mb-4">Migrene-utvikling</h3>
                    <p class="text-sm text-brand-text-light -mt-3 mb-4">Viser dager mellom anfall (linje) og styrken på anfallet (prikk).</p>
                    <div class="h-80"><canvas id="migraineDevelopmentChart"></canvas></div>
                </div>
            `;
            
            createHolisticChart(data);
            renderFocusAreaList(data);
            renderMigraineStreakCard(data);
            createMigraineDevelopmentChart(data);
            createIntensityEffectChart(data);
        };

        const renderDashboardHeader = (data) => {
            const header = document.getElementById('dashboard-header');
            const totalSessions = data.length;
            const totalMinutes = data.reduce((sum, session) => sum + parseInt(session.duration_minutes || 0), 0);
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            const totalDurationFormatted = `${hours}<span class="text-xl">t</span> ${minutes}<span class="text-xl">m</span>`;
            const firstSession = data[0];
            const lastSession = data[data.length - 1];
            const initialPain = firstSession.pre.pain_level;
            const latestPain = lastSession.post.pain_level;
            let painImprovementPercentage = 0;
            if (initialPain > 0 && initialPain > latestPain) {
                painImprovementPercentage = ((initialPain - latestPain) / initialPain) * 100;
            }
            header.innerHTML = `
                <div class="bg-brand-card p-6 rounded-2xl shadow-sm border border-brand-border flex items-center justify-between">
                    <div class="text-center">
                        <div class="text-sm text-brand-text-light font-medium">Økter</div>
                        <div class="text-4xl font-extrabold text-brand-primary">${totalSessions}</div>
                    </div>
                    <div class="text-center">
                        <div class="text-sm text-brand-text-light font-medium">Total Tid</div>
                        <div class="text-4xl font-extrabold text-brand-secondary">${totalDurationFormatted}</div>
                    </div>
                    <div class="text-center">
                        <div class="text-sm text-brand-text-light font-medium">Smerte-↓</div>
                        <div class="text-4xl font-extrabold text-green-500">${painImprovementPercentage.toFixed(0)}%</div>
                    </div>
                </div>
                <div class="bg-brand-card p-6 rounded-2xl shadow-sm border border-brand-border">
                     <h3 class="font-bold text-lg mb-2">Siste Økt</h3>
                     <p class="text-sm text-brand-text-light">
                        ${dateFns.format(new Date(lastSession.date), 'd. MMMM yyyy')}: 
                        Smerte ${lastSession.pre.pain_level} → ${lastSession.post.pain_level}, 
                        Spenning ${lastSession.pre.tightness_level} → ${lastSession.post.tightness_level}.
                     </p>
                </div>
                 <div class="bg-brand-card p-6 rounded-2xl shadow-sm border border-brand-border flex flex-col justify-center">
                    <button class="w-full bg-brand-primary text-white font-bold py-3 px-4 rounded-lg hover:bg-brand-primary-hover transition-all flex items-center justify-center gap-2" onclick="showView('logg-behandling')">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        <span>Ny Behandling</span>
                    </button>
                </div>`;
        };
        
        const renderFocusAreaList = (data) => {
            const container = document.getElementById('focusAreaList');
            if (!container) return;
            const stats = {};
            FOCUS_AREAS.forEach(area => { stats[area] = { totalPointReduction: 0, count: 0 }; });
            
            data.forEach(session => {
                if (session.focus_areas && Array.isArray(session.focus_areas)) {
                    const pointReduction = session.pre.pain_level - session.post.pain_level;
                    
                    if (pointReduction > 0 && session.focus_areas.length > 0) {
                        const reductionPerArea = pointReduction / session.focus_areas.length;
                        session.focus_areas.forEach(area => {
                            if (stats[area]) {
                                stats[area].totalPointReduction += reductionPerArea;
                                stats[area].count++;
                            }
                        });
                    }
                }
            });

            const grandTotalReduction = Object.values(stats).reduce((sum, areaStats) => sum + areaStats.totalPointReduction, 0);
            
            const ranked = Object.keys(stats)
                .map(key => ({
                    area: key,
                    contributionPercentage: grandTotalReduction > 0 ? (stats[key].totalPointReduction / grandTotalReduction) * 100 : 0,
                    count: stats[key].count
                }))
                .sort((a, b) => b.contributionPercentage - a.contributionPercentage);

            container.innerHTML = ranked.map((r, index) => {
                const isBest = index === 0 && r.contributionPercentage > 0;
                return `
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-sm font-bold text-brand-text-dark">${r.area} ${isBest ? '🏆' : ''}</span>
                            <span class="text-sm font-bold ${r.contributionPercentage > 0 ? 'text-green-600' : 'text-brand-text-light'}">${r.contributionPercentage.toFixed(0)}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="bg-brand-primary h-2.5 rounded-full" style="width: ${r.contributionPercentage}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        };

        const renderMigraineStreakCard = (data) => {
            const container = document.getElementById('migraineStreakCard');
            if (!container) return;

            const migraineEvents = data
                .filter(s => s.pre.had_migraine)
                .map(s => new Date(s.pre.last_migraine_date))
                .sort((a, b) => a - b);
            
            if (data.length === 0) return;

            let lastKnownMigraineDate;
            if (migraineEvents.length > 0) {
                lastKnownMigraineDate = migraineEvents[migraineEvents.length - 1];
            } else {
                lastKnownMigraineDate = new Date(data[0].date);
            }

            const currentStreak = dateFns.differenceInDays(new Date(), lastKnownMigraineDate);
            
            let completedStreaks = [];
            if (migraineEvents.length > 0) {
                const allDatesForStreaks = [new Date(data[0].date), ...migraineEvents];
                const uniqueDates = [...new Set(allDatesForStreaks.map(d => d.getTime()))].map(t => new Date(t)).sort((a,b) => a - b);
                
                for (let i = 1; i < uniqueDates.length; i++) {
                    const streak = dateFns.differenceInDays(uniqueDates[i], uniqueDates[i-1]);
                    completedStreaks.push(streak);
                }
            }
            
            const bestStreak = Math.max(0, ...completedStreaks, currentStreak);

            container.innerHTML = `
                <div class="flex-grow">
                    <h3 class="text-xl font-bold mb-4">Migrenefri Rekke</h3>
                    <div class="flex items-center justify-around text-center">
                        <div>
                            <div class="text-sm text-brand-text-light font-medium">Nåværende Rekke</div>
                            <div class="text-6xl font-extrabold text-brand-primary">${currentStreak}</div>
                            <div class="text-sm text-brand-text-light">dager</div>
                        </div>
                        <div>
                            <div class="text-sm text-brand-text-light font-medium">Beste Rekke</div>
                            <div class="text-4xl font-extrabold text-brand-secondary">${bestStreak}</div>
                            <div class="text-sm text-brand-text-light">dager 🏆</div>
                        </div>
                    </div>
                </div>
            `;
        };
        
        // --- CHART CREATION ---
        const createChart = (id, type, data, options) => {
            const ctx = document.getElementById(id)?.getContext('2d');
            if (ctx) chartInstances[id] = new Chart(ctx, { type, data, options });
        };

        const createHolisticChart = (data) => {
            const ctx = document.getElementById('holisticChart')?.getContext('2d');
            if (!ctx) return;
            const gradientBefore = ctx.createLinearGradient(0, 0, 0, 300);
            gradientBefore.addColorStop(0, 'rgba(236, 72, 153, 0.5)');
            gradientBefore.addColorStop(1, 'rgba(236, 72, 153, 0)');
            const gradientAfter = ctx.createLinearGradient(0, 0, 0, 300);
            gradientAfter.addColorStop(0, 'rgba(20, 184, 166, 0.5)');
            gradientAfter.addColorStop(1, 'rgba(20, 184, 166, 0)');
            createChart('holisticChart', 'line', {
                labels: data.map(s => new Date(s.date)),
                datasets: [
                    { label: 'Smerte Før', data: data.map(s => s.pre.pain_level), borderColor: '#ec4899', tension: 0.4, fill: true, backgroundColor: gradientBefore, pointBackgroundColor: '#ec4899', pointBorderColor: '#fff', pointHoverRadius: 7 },
                    { label: 'Smerte Etter', data: data.map(s => s.post.pain_level), borderColor: '#14b8a6', tension: 0.4, fill: true, backgroundColor: gradientAfter, pointBackgroundColor: '#14b8a6', pointBorderColor: '#fff', pointHoverRadius: 7 }
                ]
            }, { 
                responsive: true, maintainAspectRatio: false, 
                scales: { 
                    x: { type: 'time', time: { unit: 'month', tooltipFormat: 'd. MMM yyyy' }, grid: { display: false }, ticks: { color: '#9ca3af' } }, 
                    y: { beginAtZero: true, max: 10, grid: { color: '#e5e7eb' }, ticks: { color: '#9ca3af', stepSize: 2 } } 
                },
                plugins: { legend: { position: 'top', align: 'end', labels: { usePointStyle: true, boxWidth: 8, color: '#6b7280' } } }
            });
        };
        
        const createMigraineDevelopmentChart = (data) => {
            const migraineEvents = data.filter(s => s.pre.had_migraine);
            if (migraineEvents.length === 0) return;

            const migraineDates = [...new Set(migraineEvents.map(s => new Date(s.pre.last_migraine_date).getTime()))]
                .map(t => new Date(t))
                .sort((a,b) => a - b);

            if (migraineDates.length === 0) return;
            
            const firstDate = new Date(data[0].date);
            const allDatesForStreaks = [firstDate, ...migraineDates].sort((a,b) => a - b);
            const uniqueDates = [...new Set(allDatesForStreaks.map(d => d.getTime()))].map(t => new Date(t));

            const streaks = [];
            for (let i = 1; i < uniqueDates.length; i++) {
                const startDate = uniqueDates[i-1];
                const endDate = uniqueDates[i];
                
                const severity = data.find(s => new Date(s.pre.last_migraine_date).getTime() === endDate.getTime())?.pre.last_migraine_severity || 0;

                streaks.push({
                    x: endDate,
                    y: dateFns.differenceInDays(endDate, startDate),
                    severity: severity
                });
            }
            
            const severityToColor = (severity) => {
                const green = [20, 184, 166];
                const pink = [236, 72, 153];
                const percent = (severity - 1) / 9;
                const r = Math.round(green[0] + (pink[0] - green[0]) * percent);
                const g = Math.round(green[1] + (pink[1] - green[1]) * percent);
                const b = Math.round(green[2] + (pink[2] - green[2]) * percent);
                return `rgb(${r},${g},${b})`;
            };
            
            const ctx = document.getElementById('migraineDevelopmentChart')?.getContext('2d');
            if (!ctx) return;
            const gradient = ctx.createLinearGradient(0, 0, 0, 320);
            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.3)');
            gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');

            createChart('migraineDevelopmentChart', 'line', {
                labels: streaks.map(s => s.x),
                datasets: [{
                    label: 'Dager mellom anfall',
                    data: streaks,
                    borderColor: '#3b82f6',
                    tension: 0.4,
                    fill: true,
                    backgroundColor: gradient,
                    pointRadius: streaks.map(s => 4 + s.severity * 0.6),
                    pointBackgroundColor: streaks.map(s => severityToColor(s.severity)),
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointHoverRadius: streaks.map(s => 6 + s.severity * 0.6),
                }]
            }, {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { type: 'time', time: { unit: 'month', tooltipFormat: 'd. MMM yyyy' }, grid: { display: false }, ticks: { color: '#9ca3af' } },
                    y: { 
                        beginAtZero: true, 
                        grid: { color: '#e5e7eb' }, 
                        ticks: { color: '#9ca3af' },
                        title: { display: true, text: 'Dager mellom anfall', color: '#6b7280' }
                    }
                },
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            title: (context) => `Rekke på ${context[0].raw.y} dager`,
                            label: (context) => `Anfall ${dateFns.format(context.raw.x, 'd. MMM')}, Styrke: ${context.raw.severity}/10`,
                        }
                    }
                }
            });
        };

        const createIntensityEffectChart = (data) => {
            const stats = {};
            for(let i=1; i<=5; i++) {
                stats[i] = { totalReduction: 0, count: 0 };
            }

            data.forEach(session => {
                const intensity = session.intensity;
                if (stats[intensity]) {
                    const reduction = session.pre.pain_level - session.post.pain_level;
                    stats[intensity].totalReduction += reduction;
                    stats[intensity].count++;
                }
            });

            const chartData = Object.keys(stats).map(key => {
                return stats[key].count > 0 ? stats[key].totalReduction / stats[key].count : 0;
            });

            createChart('intensityEffectChart', 'bar', {
                labels: ['1', '2', '3', '4', '5'],
                datasets: [{
                    label: 'Gj.snitt. smertereduksjon',
                    data: chartData,
                    backgroundColor: [
                        '#a7f3d0',
                        '#6ee7b7',
                        '#34d399',
                        '#10b981',
                        '#059669'
                    ],
                    borderRadius: 4,
                    barThickness: 15,
                }]
            }, {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { grid: { display: false }, ticks: { color: '#9ca3af' }, title: {display: true, text: 'Intensitet', color: '#6b7280'} },
                    y: { 
                        beginAtZero: true, 
                        grid: { color: '#e5e7eb' }, 
                        ticks: { color: '#9ca3af' },
                    }
                },
                plugins: { 
                    legend: { display: false }
                }
            });
        };

        // --- FORM HANDLING ---
        const prepareForm = () => {
            const form = document.getElementById('behandling-skjema');
            form.innerHTML = `
                <div class="mb-6"><label for="date" class="block text-sm font-bold mb-2">Dato for behandling</label><input type="date" id="date" required class="w-full p-3 bg-brand-main border border-brand-border rounded-lg"></div>
                <div class="mb-6"><label for="duration_minutes" class="block text-sm font-bold mb-2">Varighet (minutter)</label><input type="number" id="duration_minutes" min="1" required class="w-full p-3 bg-brand-main border border-brand-border rounded-lg"></div>
                <div class="mb-8"><label class="block text-sm font-bold mb-2">Fokusområder</label><div class="checkbox-group grid grid-cols-1 sm:grid-cols-3 gap-4" id="focus_areas"></div></div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-8">
                    <!-- Før Behandling -->
                    <div class="space-y-6">
                        <h3 class="text-xl font-bold border-b pb-2">Før Behandling</h3>
                        <div><label class="flex justify-between text-sm font-bold"><span>Smertenivå</span> <span id="pre_pain_level-verdi" class="font-black text-brand-primary">5</span></label><input type="range" id="pre_pain_level" min="1" max="10" value="5"></div>
                        <div><label class="flex justify-between text-sm font-bold"><span>Muskelspenning</span> <span id="pre_tightness_level-verdi" class="font-black text-brand-primary">5</span></label><input type="range" id="pre_tightness_level" min="1" max="10" value="5"></div>
                        <div><label class="flex justify-between text-sm font-bold"><span>Intensitet</span> <span id="intensity-verdi" class="font-black text-brand-primary">3</span></label><input type="range" id="intensity" min="1" max="5" value="3"></div>
                        <div class="bg-rose-50 p-4 rounded-lg border border-rose-200">
                            <label class="block text-sm font-bold mb-2 text-brand-migrene">Har du hatt migrene siden sist?</label>
                            <div class="flex gap-4">
                                <label class="flex items-center gap-2"><input type="radio" name="had_migraine" value="yes" class="text-brand-primary focus:ring-brand-primary"> Ja</label>
                                <label class="flex items-center gap-2"><input type="radio" name="had_migraine" value="no" checked class="text-brand-primary focus:ring-brand-primary"> Nei</label>
                            </div>
                            <div id="migraine_details_container" class="mt-4 hidden space-y-4">
                                <div>
                                    <label for="migraine_date_input" class="block text-sm font-bold mb-2 text-brand-migrene">Dato for anfallet</label>
                                    <input type="date" id="migraine_date_input" class="w-full p-3 bg-white border-brand-border rounded-lg">
                                </div>
                                <div><label class="flex justify-between text-sm font-bold text-brand-migrene"><span>Styrke på anfallet</span> <span id="last_migraine_severity-verdi" class="font-black">5</span></label><input type="range" id="last_migraine_severity" min="1" max="10" value="5" style="--thumb-color: #ec4899;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Etter Behandling -->
                    <div class="space-y-6">
                        <h3 class="text-xl font-bold border-b pb-2">Etter Behandling</h3>
                        <div><label class="flex justify-between text-sm font-bold"><span>Smertenivå</span> <span id="post_pain_level-verdi" class="font-black text-green-500">5</span></label><input type="range" id="post_pain_level" min="1" max="10" value="5" style="--thumb-color: #22c55e;"></div>
                        <div><label class="flex justify-between text-sm font-bold"><span>Muskelspenning</span> <span id="post_tightness_level-verdi" class="font-black text-green-500">5</span></label><input type="range" id="post_tightness_level" min="1" max="10" value="5" style="--thumb-color: #22c55e;"></div>
                    </div>
                </div>
                <button type="submit" class="w-full mt-10 bg-brand-primary text-white font-bold py-4 px-4 rounded-lg hover:bg-brand-primary-hover transition-all text-lg">Lagre Behandlingsøkt</button>
            `;
            
            populateCheckboxes('focus_areas', FOCUS_AREAS);
            document.getElementById('date').valueAsDate = new Date();
            SLIDERS.forEach(id => {
                const slider = document.getElementById(id);
                const display = document.getElementById(`${id}-verdi`);
                if(slider && display) {
                    slider.value = slider.defaultValue;
                    display.textContent = slider.defaultValue;
                     slider.addEventListener('input', (e) => { display.textContent = e.target.value; });
                }
            });

            const migraineRadios = document.querySelectorAll('input[name="had_migraine"]');
            const detailsContainer = document.getElementById('migraine_details_container');
            migraineRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    detailsContainer.style.display = e.target.value === 'yes' ? 'block' : 'none';
                    if (e.target.value === 'yes') {
                        document.getElementById('migraine_date_input').valueAsDate = new Date();
                    }
                });
            });
        };

        document.getElementById('behandling-skjema').addEventListener('submit', async (e) => {
            e.preventDefault();
            const getChecked = (name) => Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(el => el.value);
            const getValue = id => document.getElementById(id).value;
            
            const hadMigraine = document.querySelector('input[name="had_migraine"]:checked').value === 'yes';
            
            const newSession = {
                date: getValue('date'), 
                duration_minutes: parseInt(getValue('duration_minutes')),
                focus_areas: getChecked('focus_areas'), 
                intensity: parseInt(getValue('intensity')),
                pre: {
                    pain_level: parseInt(getValue('pre_pain_level')), 
                    tightness_level: parseInt(getValue('pre_tightness_level')),
                    had_migraine: hadMigraine,
                    last_migraine_date: hadMigraine ? getValue('migraine_date_input') : null,
                    last_migraine_severity: hadMigraine ? parseInt(getValue('last_migraine_severity')) : null,
                },
                post: {
                    pain_level: parseInt(getValue('post_pain_level')), 
                    tightness_level: parseInt(getValue('post_tightness_level')),
                }
            };
            
            if (currentUser) {
                try {
                    await addDoc(collection(db, 'users', currentUser.uid, 'sessions'), newSession);
                    showView('dashboard');
                } catch (error) {
                    console.error("Error adding document: ", error);
                    alert("Kunne ikke lagre økten. Prøv igjen.");
                }
            }
        });
        
        const populateCheckboxes = (containerId, items) => {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = items.map(item => `
                <label class="flex items-center gap-3 p-4 border border-brand-border rounded-lg cursor-pointer hover:bg-teal-50 hover:border-brand-primary transition-all">
                    <input type="checkbox" name="${containerId}" value="${item}" class="h-5 w-5 rounded border-gray-300 text-brand-primary focus:ring-brand-primary"> 
                    <span class="font-bold">${item}</span>
                </label>`).join('');
        };

        // --- HISTORY & DELETE FUNCTIONS ---
        window.requestDeleteSession = (id) => {
            const card = document.querySelector(`[data-session-id='${id}']`);
            if (card) {
                card.classList.add('bg-red-50', 'border-red-200');
                card.innerHTML = `
                    <div class="text-center p-4">
                        <p class="font-bold mb-4">Er du sikker på at du vil slette denne økten?</p>
                        <div class="flex justify-center gap-4">
                            <button onclick="confirmDelete('${id}')" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600">Ja, slett</button>
                            <button onclick="updateHistory()" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">Avbryt</button>
                        </div>
                    </div>
                `;
            }
        };

        window.confirmDelete = async (id) => {
            if (currentUser) {
                await deleteDoc(doc(db, 'users', currentUser.uid, 'sessions', id));
                // The onSnapshot listener will automatically update the UI
            }
        };

        const updateHistory = (data) => {
            const liste = document.getElementById('historikk-liste');
            if(!liste) return;
            liste.innerHTML = '';
            if (!data || data.length === 0) {
                liste.innerHTML = '<div class="bg-brand-card p-8 rounded-2xl shadow-sm border border-brand-border text-center"><p>Ingen loggførte økter enda.</p></div>';
                return;
            }
            [...data].reverse().forEach(okt => {
                const el = document.createElement('div');
                el.className = 'bg-brand-card p-4 rounded-xl shadow-sm border border-brand-border transition-all';
                el.setAttribute('data-session-id', okt.id);
                el.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-bold text-lg">${dateFns.format(new Date(okt.date), 'eeee, d. MMMM yyyy')}</div>
                            <div class="text-sm text-brand-text-light">${okt.duration_minutes} minutter</div>
                        </div>
                        <button onclick="requestDeleteSession('${okt.id}')" class="text-gray-400 hover:text-red-500 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                    <div class="mt-4 pt-4 border-t border-brand-border grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                       <div><strong>Smerte:</strong> ${okt.pre.pain_level} → ${okt.post.pain_level}</div>
                       <div><strong>Spenning:</strong> ${okt.pre.tightness_level} → ${okt.post.tightness_level}</div>
                       <div><strong>Fokus:</strong> ${okt.focus_areas.join(', ')}</div>
                       <div><strong>Intensitet:</strong> ${okt.intensity}/5</div>
                    </div>
                    ${okt.pre.had_migraine ? `<div class="mt-2 pt-2 border-t border-brand-border text-sm text-brand-migrene"><strong>Migreneanfall:</strong> ${dateFns.format(new Date(okt.pre.last_migraine_date), 'd. MMM')} (Styrke: ${okt.pre.last_migraine_severity})</div>` : ''}
                `;
                liste.appendChild(el);
            });
        };
    </script>
</body>
</html>
